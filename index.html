<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waypoint Manager</title>
    <style>
        #waypointUI {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
        }
        button {
            display: block;
            margin: 5px 0;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- UI Container will be created dynamically -->

    <script>
        window.onload = function () {
            const locations = JSON.parse(localStorage.getItem("waypoints")) || [];
            let currentIndex = 0;
            let looping = false;

            // Create UI container
            let uiContainer = document.createElement("div");
            uiContainer.id = "waypointUI";

            // Add buttons to the UI
            uiContainer.innerHTML = `
                <button id="addCurrentBtn">Add Current Location</button>
                <button id="startLoopBtn">Start</button>
                <button id="stopLoopBtn">Stop</button>
                <button id="skipBtn">Skip Waypoint</button>
                <div id="waypointList" style="margin-top: 10px;"></div>
            `;
            document.body.appendChild(uiContainer);

            console.log("UI Panel Created", uiContainer); // Debugging

            function updateWaypointList() {
                const listContainer = document.getElementById("waypointList");
                if (!listContainer) {
                    console.error("Waypoint list container not found!");
                    return;
                }
                listContainer.innerHTML = locations.map((loc, index) =>
                    `<div>${index + 1}: (${loc.x}, ${loc.y})</div>`
                ).join("");
            }

            function addWaypoint(x, y) {
                locations.push({ x, y });
                localStorage.setItem("waypoints", JSON.stringify(locations));
                updateWaypointList();
            }

            function addCurrentLocation() {
                fetch("game://getData")
                    .then(response => response.json())
                    .then(data => {
                        if (data.pos_x && data.pos_y) {
                            addWaypoint(data.pos_x, data.pos_y);
                        }
                    }).catch(err => console.error("Error fetching game data:", err));
            }

            function setWaypoint(x, y) {
                fetch("game://sendCommand", {
                    method: "POST",
                    body: JSON.stringify({ type: "setWaypoint", x, y })
                }).catch(err => console.error("Error setting waypoint:", err));
            }

            function checkArrival() {
                fetch("game://getData")
                    .then(response => response.json())
                    .then(data => {
                        let { pos_x, pos_y } = data;
                        let { x, y } = locations[currentIndex];
                        let distance = Math.sqrt(Math.pow(pos_x - x, 2) + Math.pow(pos_y - y, 2));
                        if (distance < 10) {
                            nextWaypoint();
                        } else {
                            setTimeout(checkArrival, 2000);
                        }
                    }).catch(err => console.error("Error checking arrival:", err));
            }

            function nextWaypoint() {
                if (locations.length === 0) return;
                currentIndex = (currentIndex + 1) % locations.length;
                let { x, y } = locations[currentIndex];
                setWaypoint(x, y);
                checkArrival();
            }

            function skipWaypoint() {
                nextWaypoint();
            }

            function startLoop() {
                if (looping || locations.length === 0) return;
                looping = true;
                nextWaypoint();
            }

            function stopLoop() {
                looping = false;
            }

            // Attach event listeners after UI elements are created
            document.getElementById("addCurrentBtn").addEventListener("click", addCurrentLocation);
            document.getElementById("startLoopBtn").addEventListener("click", startLoop);
            document.getElementById("stopLoopBtn").addEventListener("click", stopLoop);
            document.getElementById("skipBtn").addEventListener("click", skipWaypoint);

            updateWaypointList();
        };
    </script>

</body>
</html>
