window.onload = function () {
    const locations = JSON.parse(localStorage.getItem("waypoints")) || [];
    let currentIndex = 0;
    let looping = false;

    // Create UI container
    let uiContainer = document.createElement("div");
    uiContainer.id = "waypointUI";
    uiContainer.style = "position: fixed; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.8); padding: 10px; border-radius: 5px; color: white;";

    // Add buttons
    uiContainer.innerHTML = `
        <button id="addCurrentBtn">Add Current Location</button>
        <button id="startLoopBtn">Start</button>
        <button id="stopLoopBtn">Stop</button>
        <button id="skipBtn">Skip Waypoint</button>
        <div id="waypointList" style="margin-top: 10px;"></div>
    `;
    document.body.appendChild(uiContainer);

    function updateWaypointList() {
        const listContainer = document.getElementById("waypointList");
        listContainer.innerHTML = locations.map((loc, index) =>
            `<div>${index + 1}: (${loc.x}, ${loc.y})</div>`
        ).join("");
    }

    function addWaypoint(x, y) {
        locations.push({ x, y });
        localStorage.setItem("waypoints", JSON.stringify(locations));
        updateWaypointList();
    }

    function addCurrentLocation() {
        fetch("game://getData")
            .then(response => response.json())
            .then(data => {
                if (data.pos_x && data.pos_y) {
                    addWaypoint(data.pos_x, data.pos_y);
                }
            });
    }

    function setWaypoint(x, y) {
        fetch("game://sendCommand", {
            method: "POST",
            body: JSON.stringify({ type: "setWaypoint", x, y })
        });
    }

    function checkArrival() {
        fetch("game://getData")
            .then(response => response.json())
            .then(data => {
                let { pos_x, pos_y } = data;
                let { x, y } = locations[currentIndex];
                let distance = Math.sqrt(Math.pow(pos_x - x, 2) + Math.pow(pos_y - y, 2));
                if (distance < 10) {
                    nextWaypoint();
                } else {
                    setTimeout(checkArrival, 2000);
                }
            });
    }

    function nextWaypoint() {
        if (locations.length === 0) return;
        currentIndex = (currentIndex + 1) % locations.length;
        let { x, y } = locations[currentIndex];
        setWaypoint(x, y);
        checkArrival();
    }

    function skipWaypoint() {
        nextWaypoint();
    }

    function startLoop() {
        if (looping || locations.length === 0) return;
        looping = true;
        nextWaypoint();
    }

    function stopLoop() {
        looping = false;
    }

    document.getElementById("addCurrentBtn").addEventListener("click", addCurrentLocation);
    document.getElementById("startLoopBtn").addEventListener("click", startLoop);
    document.getElementById("stopLoopBtn").addEventListener("click", stopLoop);
    document.getElementById("skipBtn").addEventListener("click", skipWaypoint);

    updateWaypointList();
};
